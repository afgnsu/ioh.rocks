<script>
	$(document).ready(function () {

		$('#calendar').fullCalendar({
			header: {
				left: 'prev, next',
				right: 'agendaWeek, agendaDay'
			},
			defaultView: 'agendaWeek',
			defaultDate: '2016-07-18',
			gotoDate: '2016-07-18',
			hiddenDays: [
				4, 5
			],
			minTime: '14:00',
			maxTime: '22:30',
			aspectRatio: 0.95,
			weekends: false,
			allDaySlot: false,
			nowIndicator: true,
			editable: true,
			eventLimit: true, // allow "more" link when too many events
			eventDurationEditable: false,
			viewRender: function (currentView) {
				var minDate = new Date('2016-07-18');
				maxDate = new Date('2016-07-21');

				if (minDate >= currentView.start && minDate <= currentView.end) {
					$(".fc-prev-button").prop('disabled', true);
					$(".fc-prev-button").addClass('fc-state-disabled');
				} else {
					$(".fc-prev-button").removeClass('fc-state-disabled');
					$(".fc-prev-button").prop('disabled', false);
				}
				// Future
				if (maxDate >= currentView.start && maxDate <= currentView.end) {
					$(".fc-next-button").prop('disabled', true);
					$(".fc-next-button").addClass('fc-state-disabled');
				} else {
					$(".fc-next-button").removeClass('fc-state-disabled');
					$(".fc-next-button").prop('disabled', false);
				}

			},
			eventSources: [
				{
					// url: 'http://ioh.rocks/api/live.json',
					url: '/api/live.json',
					type: 'GET',
					error: function () {
						alert('there was an error while fetching events!');
					},
					success: function (json) {
						var user_idObj = {};
						$.each(json, function (index, data) {

							if (!(data['user_id'] in user_idObj))
								user_idObj[data['user_id']] = 1;
							else
								user_idObj[data['user_id']] += 1;

							data['id'] = index;

							data['title'] += ('\n' + data['school'] + '\n' + data['department']);

							$.each(data, function (key, value) {
								if (key === 'start' || key === 'end')
									data[key] = new Date(value);
								}
							)
						})

						$.each(json, function (index, data) {
							if (user_idObj[data['user_id']] <= 2)
								data['color'] = '#333399';
							else if (user_idObj[data['user_id']] <= 4)
								data['color'] = '#009933';
							else
								data['color'] = '#CC9933';
							}
						)
					}
				}
			],
			eventDrop: function (event, delta, revertFunc) {
				//alert(event.title + " was dropped on " + event.start.format()); 這裡要寫auto save
			},
			eventClick: function (calEvent, jsEvent, view) {
				$('.fc-title').each(function () {

					var parents = $(this).parents('a');
					var selected = false;
					if (parents.hasClass('selected')) {
						selected = true;
						$(this).parent().siblings('span').removeClass('closon_selected');
					}

					parents.removeClass('selected');
					if ($(this).text() == calEvent.title.replace(/(?:\n)/g, '') && !selected) {
						$(this).parent().siblings('span').addClass('closon_selected');
						parents.addClass('selected');
					}

				});
				$('.closon').click(function () {
					$('#calendar').fullCalendar('removeEvents', calEvent._id);
				});
				//alert('Event: ' + calEvent.title); change the border color just for fun $(this).css('border-color', 'red');
			},
			eventAfterRender: function (event, element, view) {
				var element = $(element);
				element.addClass('event_customize');
				//console.log(element);
				// if (element[0].childElementCount == 2)
				// 	element.css('left', '40%');
				// else if (element[0].childElementCount == 3)
				// 	element.css('left', '60%');
				// else if (element[0].childElementCount == 4)
				// 	element.css('left', '80%');
			},
			eventAfterAllRender: function (view) {
				$(".fc-time-grid-event").append("<span class='closon'>隱藏</span>");
			},
			displayEventTime: false,
			slotLabelFormat: 'H:mm',
			slotLabelInterval: 30,
			views: {
				agenda: {
					columnFormat: 'dddd MM/DD'
				}
			}
		});

	});
</script>
<style>

	body {
		margin: 40px 10px;
		padding: 0;
		font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
		font-size: 14px;
	}

	#calendar {
		margin: 0 auto;
	}

	.selected {
		background-color: red !important;
	}

	.closon {
		position: absolute;
		left: 1px;
		bottom: -1px;
		cursor: pointer;
		color: transparent;
		z-index: 10;
	}

	.closon_selected {
		color: black;
	}

	.event_customize {
		padding-top: 3px;
		/*width: 20%;*/
		/*text-align: center;*/
		margin-right: 0;
	}

</style>
<%= render "live_nav" %>
<div id='calendar'></div>
