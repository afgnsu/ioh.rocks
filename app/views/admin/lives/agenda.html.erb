<style>
	table {
		border-collapse: collapse !important;
	}

	table,
	td,
	th {
		border: 1px solid black !important;
	}
	.table > tbody > tr > td.time_td {
		vertical-align: middle;
	}

	.thaed_css {
		width: 31.666%;
	}

	.final_slot {
		background-color: white;
	}

	.all_td_final {
		background-color: rgba(0, 0, 0, 0.2);
		height: 5em;
		vertical-align: middle !important;
	}

	.all_td_event {
		width: 30px;
		height: 70px;
		font-size: 0.75em;
		color: white;
		cursor: pointer;
	}

	.blue_background {
		background-color: #333399;
	}

	.green_background {
		background-color: #009933;
	}

	.orange_background {
		background-color: #CC9933;
	}

	.selected {
		background-color: red !important;
		outline: 3px solid black !important;
	}

	.closon {
		width: 50%;
		display: none;
		cursor: pointer;
		text-align: left;
		color: black;
		z-index: 10;
	}

</style>

<%= render "live_nav" %>

<table class="table text-center table-condensed">
	<thead>
		<tr>
			<th style="width: 5%;"></th>
			<th class="text-center thaed_css" colspan="5">Monday 7/18</th>
			<th class="text-center thaed_css" colspan="5">Tuesday 7/19</th>
			<th class="text-center thaed_css" colspan="5">Wednesday 7/20</th>
		</tr>
	</thead>
	<tbody></tbody>
</table>

<script type="text/javascript">
	var user_idObj = {},
			time_idObj = {37:[], 38:[], 39:[], 40:[], 41:[], 42:[], 43:[], 44:[], 45:[], 46:[],
										47:[], 48:[], 49:[], 50:[], 51:[], 52:[], 53:[], 54:[], 55:[], 56:[],
										57:[], 58:[], 59:[], 60:[], 61:[], 62:[], 63:[], 64:[], 65:[], 66:[]},
			time_startArr = [],
			time_endArr = [];
	var json = (function () {
		var json = null;
		$.ajax({
			'async': false,
			'global': false,
			'url': 'http://ioh.rocks/api/live.json',
			'dataType': "json",
			'success': function (data) {
				json = data;
				$.each(json, function (index, data) {

					if (!(data['user_id'] in user_idObj))
						user_idObj[data['user_id']] = 1;
					else
						user_idObj[data['user_id']] += 1;

					data['id'] = index;

					data['title'] += ('<br>' + data['school'] + '<br>' + data['department']);

					$.each(data, function (key, value) {
						if (key === 'start') {
							var date = new Date(value);
							data[key] = (date.getMonth() + 1) + '/' + date.getDate() + ' ' + date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
							if (!(time_startArr.indexOf(data[key]) > -1))
								time_startArr.push(data[key]);
							}
						else if (key === 'end') {
							var date = new Date(value);
							data[key] = (date.getMonth() + 1) + '/' + date.getDate() + ' ' + date.getHours() + ':' + (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
							if (!(time_endArr.indexOf(data[key]) > -1))
								time_endArr.push(data[key]);
						}
					})

					time_idObj[data['time_id']].push({
						id: data['id'],
						user_id: data['user_id'],
						title: data['title']
					});
				})
			}
		});
		return json;
	})();

	// console.log(time_startArr); console.log(time_endArr);
	//console.log(time_idObj);

	var renderHtml_1 = '', renderHtml_2 = '';

	//render出final slot
	for (var i = 0; i < 10; i++) {

		renderHtml_1 += '<tr class="final_slot" id="final_slot_' + i + '">';
		renderHtml_1 += '<td class="time_td"><b>' + time_startArr[i].substring(5, 10) + '<br>~<br>' + time_endArr[i].substring(5, 10) + '</b></td>';

		for (var y = 1; y <= 5; y++) {
			renderHtml_1 += '<td class="all_td_final"> <div class="mon_div"><b>' + y + '</b></div> </td>';
		}

		for (var y = 1; y <= 5; y++) {
			renderHtml_1 += '<td class="all_td_final"> <div class="tue_div"><b>' + y + '</b></div> </td>';
		}

		for (var y = 1; y <= 5; y++) {
			renderHtml_1 += '<td class="all_td_final"> <div class="tue_div"><b>' + y + '</b></div> </td>';
		}

		renderHtml_1 += '</tr>';
	}

	$('tbody').append(renderHtml_1);

	//render出講者資訊
	for (var i = 0; i < 10; i++) {

		var mon_data = i + 37,
				tue_data = i + 47,
				wed_data = i + 57;
		var rowNum = Math.max(time_idObj[mon_data].length / 5, time_idObj[tue_data].length / 5, time_idObj[wed_data].length / 5);
		rowNum = Math.ceil(rowNum);
		renderHtml_2 = '';

		for (var j = 0; j < rowNum; j++) {
			var fiveJ = j * 5;
			renderHtml_2 += '<tr>';
			renderHtml_2 += '<td></td>';

			for (var z = 0; z < 5; z++) {
				if(time_idObj[mon_data][fiveJ + z])
					renderHtml_2 += '<td class="mon_td_event all_td_event" data="' + time_idObj[mon_data][fiveJ + z].id + '" user_id="' + time_idObj[mon_data][fiveJ + z].user_id + '""> <div class="mon_div"><b>' + time_idObj[mon_data][fiveJ + z].title + '</b></div> <div class="closon">隱藏</div> </td>';
				else
					renderHtml_2 += '<td class="mon_td_event all_td_event" data="" user_id=""> <div class="mon_div"><b></b></div> </td>';
			}

			for (var z = 0; z < 5; z++) {
				if(time_idObj[tue_data][fiveJ + z])
					renderHtml_2 += '<td class="tue_td_event all_td_event" data="' + time_idObj[tue_data][fiveJ + z].id + '" user_id="' + time_idObj[tue_data][fiveJ + z].user_id + '""> <div class="mon_div"><b>' + time_idObj[tue_data][fiveJ + z].title + '</b></div> <div class="closon">隱藏</div> </td>';
				else
					renderHtml_2 += '<td class="tue_td_event all_td_event" data=""> <div class="tue_div"><b></b></div> </td>';
			}

			for (var z = 0; z < 5; z++) {
				if(time_idObj[wed_data][fiveJ + z])
					renderHtml_2 += '<td class="wed_td_event all_td_event" data="' + time_idObj[wed_data][fiveJ + z].id + '" user_id="' + time_idObj[wed_data][fiveJ + z].user_id + '"""> <div class="wed_div"><b>' + time_idObj[wed_data][fiveJ + z].title + '</b></div> <div class="closon">隱藏</div> </td>';
				else
					renderHtml_2 += '<td class="wed_td_event all_td_event" data=""> <div class="wed_div"><b></b></div> </td>';
			}

			renderHtml_2 += '</tr>';
		}
		var selector = 'tr#final_slot_' + i + '.final_slot';
		$(selector).before(renderHtml_2);
	}

	//上背景色
	$('td.all_td_event').each(function(){
		var tmp = user_idObj[$(this).attr('user_id')];
		if(tmp <= 2)
			$(this).addClass('blue_background');
		else if(tmp <= 4)
			$(this).addClass('green_background');
		else {
			$(this).addClass('orange_background');
		}
	});

	//td_event click event
	$('.all_td_event').click(function(){
		console.log("event");
		var _this_user_id = $(this).attr('user_id');
		if(_this_user_id != "") {
			$('td.all_td_event').each(function(){
				if($(this).attr('user_id') == _this_user_id){
					if($(this).hasClass('selected')) {
						$(this).removeClass('selected');
						$(this).children('.closon').hide();
					}
					else {
						$(this).addClass('selected');
						$(this).children('.closon').show();
					}
				}
			});
		}
	});

	$('.closon').click(function () {
		console.log("closon");
		$(this).parents('.selected').unbind('click');
		$(this).parents('.selected').css('visibility', 'hidden');
	});


</script>
